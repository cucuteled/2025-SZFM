<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/css/contactStyle.css">
    <title>Étterem</title>
    <style>
        body { margin: 0; padding: 0; min-height: 100vh; background-image: url('/pictures/homepage.jpg'); background-size: cover; background-position: center; font-family: Arial, sans-serif; color: white; }
        .sidebar { position: fixed; top: 0; left: 0; width: 200px; height: 100%; background-color: rgba(128,128,128,0.5); border-top-right-radius: 15px; border-bottom-right-radius: 15px; padding: 20px; box-sizing: border-box; }
        .title { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(128,128,128,0.5); padding: 10px 30px; border-radius: 20px; font-size: 24px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        .auth-btn { position: absolute; top: 20px; right: 20px; background-color: rgba(128,128,128,0.5); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-decoration: none; }
        .auth-btn:hover{ background-color: rgba(180,180,180,0.7); transform: scale(1.05); }
        .sidebar button { display: block; width: 100%; margin: 10px 0; padding: 10px; background-color: rgba(255,255,255,0.1); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .sidebar button:hover { background-color: rgba(255,255,255,0.3); transform: translateX(5px); }
        .screencontent { margin-left: 220px; padding: 30px; padding-top: 100px; display: block; flex-wrap: wrap; gap: 20px; }
        .etel-kartya { background-color: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; width: 200px; color: white; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(3px); transition: transform 0.3s ease; }
        .ital-kartya { background-color: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; width: 200px; color: white; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(3px); transition: transform 0.3s ease; }
        .etel-kartya:hover { transform: scale(1.05); }
        .ital-kartya:hover { transform: scale(1.05); }
        .etel-kartya img { width: 100%; border-radius: 8px; margin-bottom: 10px; }
        .ital-kartya img { width: 100%; border-radius: 8px; margin-bottom: 10px; }
        .etel-kartya .nev { font-weight: bold; font-size: 18px; margin-bottom: 5px; text-align:center; }
        .ital-kartya .nev { font-weight: bold; font-size: 18px; margin-bottom: 5px; text-align:center; }
        .etel-kartya .ar { font-size: 16px; margin-bottom: 10px; }
        .ital-kartya .ar { font-size: 16px; margin-bottom: 10px; }
        .etel-kartya button { background-color: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; }
        .ital-kartya button { background-color: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; }
        .etel-kartya button:hover { background-color: rgba(255,255,255,0.4); }
        .ital-kartya button:hover { background-color: rgba(255,255,255,0.4); }
        .hero { margin-left: 220px; padding: 60px 40px 20px 40px; color: white; }
        .hero h1 { font-size: 36px; margin: 0 0 10px 0; letter-spacing: 2px; }
        .hero p { margin: 0 0 16px 0; max-width: 800px; color: #fffdd0; }
        section {margin-bottom: 60px;}
        .etel-lista,
        .ital-lista {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
        }

		.wmsg {
			color:#fff;
			text-align:left;

		/* fekete körvonal (sok kis shadow minden irányban) */
			text-shadow:
				1px 1px 0 #000,

				/* plusz glow fehérrel */
				0 0 50px #fff,
				0 0 50px #ccc;
		}

        .cart-btn {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: rgba(128,128,128,0.5);
            color: white;
            border: none;
            padding: 10px 45px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .cart {
            position: absolute;
            top: 100px;
            right: 20px;
            background-color: rgba(128,128,128,0.8);
            color: white;
            border-radius: 20px;
            padding: 20px;
            width: 250px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .cart-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .cart button.order-btn {
            align-self: center;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="sidebar">
    <button onclick="fooldal()">Főoldal</button>
    <button onclick="listfoods()">Menü</button>
    <button onclick="rolunk()">Rólunk</button>
    <button onclick="kapcsolat()">Kapcsolat</button>
    <a id="myprofilebutton" style="text-decoration:none; visibility: hidden;"><button style="align:top; background-color: rgba(100,100,100,0.1);">Profilom</button></a>
</div>

<div class="title">ÉTTEREM</div>

<button id="authBtn" class="auth-btn">Bejelentkezés</button>
<button id="cartBtn" class="cart-btn" onclick="opencart()">Kosár</button> <!-- onmouseleave="closecart()" !-->

<!-- Hero / Főoldal tartalom -->
<div id="hero" class="hero" style="display:none;">
    <h1 class="wmsg">Üdvözlünk az Étteremben</h1>
    <p class="wmsg">Kínálatunk friss, finom és helyi alapanyagokból készül. Nézd meg a menüt, és ha tetszik valami, tedd a kosárba — a rendeléshez be kell jelentkezni.</p>
    <button onclick="listfoods()" style="padding:10px 16px;border-radius:12px;border:none;background:rgba(255,255,255,0.15);color:white;cursor:pointer">Megnézem a menüt</button>
</div>

<div id="etel-container" class="screencontent"></div>



<script>
    // --- segédf-ök ---
        async function opencart() {
            // Ne nyisson többet, ha már van
            if (document.getElementById('cartDiv')) return;

            const cartDiv = document.createElement('div');
            cartDiv.id = 'cartDiv';
            cartDiv.className = 'cart';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'cart-content';

            try {
                const res = await fetch('/api/v1/cart/getcart', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (res.ok) {
                    const items = await res.json();

                    if (items.length === 0) {
                        contentDiv.textContent = "A kosarad üres.";
                    } else {
                        const list = document.createElement('ul');
                        list.style.listStyle = 'none';
                        list.style.padding = '0';
            // itemek hozzáadása !!!!!!!!!!!!!!!!!!
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.style.textDecoration = 'underline'; // Aláhúzás
                    li.style.cursor = 'pointer'; // Kurzor kézre vált
                    li.title = 'Mennyiség csökkentése -1-el'; // Tooltip szöveg

                    const total = item.price * item.quantity;
                    li.textContent = `${item.name} - ${item.quantity} db = ${total} Ft`;

                    li.addEventListener('click', async () => {
                        try {
                            const res = await fetch(`/api/v1/cart/remove/${encodeURIComponent(item.productId)}?type=${encodeURIComponent(item.type)}`, {
                                method: 'POST',
                                credentials: 'same-origin'
                            });

                            if (res.ok) {
                                closecart();
                                opencart(); // újratöltjük a kosarat
                            } else {
                                const msg = await res.text().catch(() => res.statusText);
                                alert("Hiba a törlés során: " + msg);
                            }
                        } catch (err) {
                            console.error(err);
                            alert("Hálózati hiba: " + err.message);
                        }
                    });

					const br = document.createElement('br');
					const hr = document.createElement('hr');
                    list.appendChild(li);
					// szépítés
					list.appendChild(br);
					list.appendChild(hr);
					list.appendChild(br);
                });
        // vége!!!!!!!!!!!!!
                        contentDiv.appendChild(list);
                    }
                } else {
                    contentDiv.textContent = "Jelentkezz be a kosarad megtekintéséhez!";
                }
            } catch (e) {
                contentDiv.textContent = "Nem sikerült lekérni a kosár tartalmát.";
            }

            // Megrendelem gomb
            const orderBtn = document.createElement('button');
            orderBtn.className = 'order-btn';
            orderBtn.textContent = 'Megrendelem';

            orderBtn.onclick = async function() {
                const res = await fetch('/api/v1/cart/order', { method: 'POST', credentials: 'same-origin' });
                if (res.ok) {
                    alert('Rendelés sikeres!');
                    closecart();
                } else {
                    alert('Rendelés sikertelen!');
                }
            };

            cartDiv.appendChild(contentDiv);
            cartDiv.appendChild(orderBtn);

            // Eltüntetés egér elhagyásakor
            cartDiv.addEventListener('mouseleave', closecart);

            document.body.appendChild(cartDiv);
        }


        function closecart() {
            const cartDiv = document.getElementById('cartDiv');
            if (cartDiv) {
                cartDiv.remove();
            }
        }

    function deletecontent(){ document.getElementById('etel-container').innerHTML = ''; document.getElementById('hero').style.display = 'none'; }
    function fooldal(){
      deletecontent();
      document.getElementById('hero').style.display = 'block';
    }
    function rolunk(){ deletecontent(); document.getElementById('etel-container').innerHTML = '<h2>Rólunk</h2><p>Itt a rólunk tartalom.</p>'; }
    function kapcsolat()
    {
        deletecontent();
        document.getElementById('etel-container').innerHTML = `
    <div class="contact-container">
    <h1>Kapcsolat</h1>
    <form id="contactForm">
      <label for="name">Név:</label><br>
      <input type="text" id="name" required><br><br>

      <label for="email">E-mail:</label><br>
      <input type="email" id="email" required><br><br>

      <label for="message">Üzenet:</label><br>
      <textarea id="message" rows="6" cols="40" required></textarea><br><br>

      <button type="submit">Küldés</button>
    </form>
    <p id="contactResponse"></p>

    </div>
  `;

        // --- JS fetch logika ---
        const form = document.getElementById("contactForm");
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById("name").value,
                email: document.getElementById("email").value,
                message: document.getElementById("message").value
            };

            try {
                const res = await fetch("/api/contact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const text = await res.text();
                document.getElementById("contactResponse").innerText = res.ok
                    ? "Üzenet sikeresen elküldve!"
                    : "Hiba: " + text;

            } catch (err) {
                document.getElementById("contactResponse").innerText = "Hálózati hiba: " + err.message;
            }
        });
    }

    // -- auth státusz lekérése és gomb beállítása --
    async function loadAuthStatus(){
      const btn = document.getElementById('authBtn');
      btn.textContent = 'Betöltés...';
      btn.onclick = null;

      try {
        const res = await fetch('/api/v1/auth/me', { method: 'GET', credentials: 'same-origin' });
        if (res.ok) {
          const user = await res.json();
          const display = (user && user.email) ? user.email : 'Profil';
          btn.textContent = 'Kijelentkezés (' + display + ')';
          btn.onclick = () => { if (confirm('Biztos kijelentkezel?')) logout(); };
          const profilgomb = document.getElementById("myprofilebutton");
          profilgomb.style.visibility = 'visible';
          profilgomb.onclick = () => window.location.href = '/myprofile';
        } else {
            loggedoutstate();
        }
      } catch (err) {
        console.error('Auth státusz hiba:', err);
        loggedoutstate();
      }
    }
    // DRY
    function loggedoutstate() {
        const btn = document.getElementById('authBtn');
        btn.textContent = 'Bejelentkezés';
        btn.onclick = () => window.location.href = '/login';
        //
        const profilgomb = document.getElementById("myprofilebutton");
        profilgomb.style.visibility = 'hidden';
    }

    async function logout(){
      try {
        const res = await fetch('/api/v1/auth/logout', { method: 'POST', credentials: 'same-origin' });
        if (res.ok) {
          await loadAuthStatus();
          alert('Sikeres kijelentkezés.');
          fooldal();
        } else {
          const t = await res.text().catch(()=>res.statusText);
          alert('Kijelentkezési hiba: ' + t);
        }
      } catch (e) {
        alert('Hálózati hiba: ' + e.message);
      }
    }
    
    // ételek listázása
    async function listetelek() {
        const mainContainer = document.getElementById('etel-container');

        // --- Ételek szekció ---
        const etelSection = document.createElement('section');
        etelSection.innerHTML = '<h2>Ételek</h2>';
        mainContainer.appendChild(etelSection);

        const etelContainer = document.createElement('div');
        etelContainer.className = 'etel-lista';
        etelSection.appendChild(etelContainer);

        const etelLoading = document.createElement('div');
        etelLoading.textContent = 'Ételek betöltése...';
        etelContainer.appendChild(etelLoading);

        try {
            const resEtelek = await fetch('/etelek', { method: 'GET', credentials: 'same-origin' });
            if (!resEtelek.ok) throw new Error(await resEtelek.text());
            const etelek = await resEtelek.json();

            etelContainer.innerHTML = etelek.length
                ? ''
                : '<p>Nincs elérhető étel.</p>';

            etelek.forEach(etel => {
                const kartya = document.createElement('div');
                kartya.className = 'etel-kartya';
                const kepNev = (etel.name || 'default').toLowerCase();
                const kepEleres = `/pictures/${encodeURIComponent(kepNev)}.jpg`;
                const idVal = etel.id ?? etel.name;

                kartya.innerHTML = `
        <img src="${kepEleres}" alt="${escapeHtml(etel.name)}" onerror="this.src='/pictures/default.jpg'">
        <div class="nev">${escapeHtml(etel.name)}</div>
        <div class="ar">${escapeHtml(String(etel.price))} Ft</div>
        <button type="button">Hozzáadás</button>
      `;

                kartya.querySelector('button').addEventListener('click', () => addToCart(idVal, "etel"));
                etelContainer.appendChild(kartya);
            });

        } catch (err) {
            console.error('Hiba az ételek lekérésekor:', err);
            etelContainer.innerHTML = '<p>Hiba történt az ételek betöltésekor.</p>';
        }
    }
    
    // italok listázása
    async function listitalok() {
        const mainContainer = document.getElementById('etel-container');
        
        // --- Italok szekció ---
        const italSection = document.createElement('section');
        italSection.innerHTML = '<h2>Italok</h2>';
        mainContainer.appendChild(italSection);

        const italContainer = document.createElement('div');
        italContainer.className = 'ital-lista';
        italSection.appendChild(italContainer);

        const italLoading = document.createElement('div');
        italLoading.textContent = 'Italok betöltése...';
        italContainer.appendChild(italLoading);

        try {
            const resItalok = await fetch('/italok', { method: 'GET', credentials: 'same-origin' });
            if (!resItalok.ok) throw new Error(await resItalok.text());
            const italok = await resItalok.json();

            italContainer.innerHTML = italok.length
                ? ''
                : '<p>Nincs elérhető ital.</p>';

            italok.forEach(ital => {
                const kartya = document.createElement('div');
                kartya.className = 'ital-kartya';
                const kepNev = (ital.name || 'default').toLowerCase();
                const kepEleres = `/pictures/${encodeURIComponent(kepNev)}.jpg`;
                const idVal = ital.id ?? ital.name;

                kartya.innerHTML = `
        <img src="${kepEleres}" alt="${escapeHtml(ital.name)}" onerror="this.src='/pictures/default.jpg'">
        <div class="nev">${escapeHtml(ital.name)}</div>
        <div class="ar">${escapeHtml(String(ital.price))} Ft</div>
        <button type="button">Hozzáadás</button>
      `;

                kartya.querySelector('button').addEventListener('click', () => addToCart(idVal, "ital"));
                italContainer.appendChild(kartya);
            });

        } catch (err) {
            console.error('Hiba az italok lekérésekor:', err);
            italContainer.innerHTML = '<p>Hiba történt az italok betöltésekor.</p>';
        }
    }

    // -- ételek betöltése --
    async function listfoods() {
        deletecontent();
        listetelek();
        listitalok(); // DRY!!!
    }

    function escapeHtml(str){ if (str == null) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    // -- kosár hozzáadás --
    async function addToCart(productId, type = 'etel') {
      try {
        const res = await fetch(`/api/v1/cart/add/${encodeURIComponent(productId)}?type=${encodeURIComponent(type)}`, {
          method: 'POST',
          credentials: 'same-origin'
        });
    
        if (res.status === 403 || res.status === 401) {
          const go = confirm('A kosár használatához be kell jelentkezned. Belépsz most?');
          if (go) window.location.href = '/login';
          return;
        }
    
        if (!res.ok) {
          const text = await res.text().catch(()=>res.statusText);
          alert('Hiba: ' + text);
          return;
        }
    
        const body = await res.text();
        alert(body || 'Sikeresen hozzáadva a kosárhoz!');
    
      } catch (err) {
        console.error('addToCart hiba:', err);
        alert('Hálózati hiba: ' + err.message);
      }
    }

    // init
    window.addEventListener('load', () => {
      loadAuthStatus();
      fooldal(); // nyitáskor főoldal
    });
</script>
</body>
</html>
