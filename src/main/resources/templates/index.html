<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" href="/css/contactStyle.css">
    <link rel="stylesheet" href="/css/aboutStyle.css">
    <title>Étterem</title>
    <style>
        body { margin: 0; padding: 0; min-height: 100vh; background-image: url('/pictures/homepage.jpg'); background-size: cover; background-position: center; font-family: Arial, sans-serif; color: white; display: block;}
        .sidebar { position: fixed; top: 0; left: 0; width: 200px; height: 100%; background-color: rgba(128,128,128,0.5); border-top-right-radius: 15px; border-bottom-right-radius: 15px; padding: 20px; box-sizing: border-box; }
        .title { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(128,128,128,0.5); padding: 10px 30px; border-radius: 20px; font-size: 24px; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        .auth-btn { position: absolute; top: 20px; right: 20px; background-color: rgba(128,128,128,0.5); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; text-decoration: none; }
        .auth-btn:hover{ background-color: rgba(180,180,180,0.7); transform: scale(1.05); }
        .sidebar button { display: block; width: 100%; margin: 10px 0; padding: 10px; background-color: rgba(255,255,255,0.1); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; }
        .sidebar button:hover { background-color: rgba(255,255,255,0.3); transform: translateX(5px); }
        .screencontent { margin-left: 220px; padding: 30px; padding-top: 100px; display: block; flex-wrap: wrap; gap: 20px; }
        .etel-kartya { background-color: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; width: 200px; color: white; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(3px); transition: transform 0.3s ease; }
        .ital-kartya { background-color: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; width: 200px; color: white; display: flex; flex-direction: column; align-items: center; backdrop-filter: blur(3px); transition: transform 0.3s ease; }
        .etel-kartya:hover { transform: scale(1.05); }
        .ital-kartya:hover { transform: scale(1.05); }
        .etel-kartya img { width: 100%; border-radius: 8px; margin-bottom: 10px; }
        .ital-kartya img { width: 100%; border-radius: 8px; margin-bottom: 10px; }
        .etel-kartya .nev { font-weight: bold; font-size: 18px; margin-bottom: 5px; text-align:center; }
        .ital-kartya .nev { font-weight: bold; font-size: 18px; margin-bottom: 5px; text-align:center; }
        .etel-kartya .ar { font-size: 16px; margin-bottom: 10px; }
        .ital-kartya .ar { font-size: 16px; margin-bottom: 10px; }
        .etel-kartya button { background-color: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; }
        .ital-kartya button { background-color: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease; }
        .etel-kartya button:hover { background-color: rgba(255,255,255,0.4); }
        .ital-kartya button:hover { background-color: rgba(255,255,255,0.4); }
        .hero { margin-left: 220px; padding: 60px 40px 20px 40px; color: white; }
        .hero h1 { font-size: 36px; margin: 0 0 10px 0; letter-spacing: 2px; }
        .hero p { margin: 0 0 16px 0; max-width: 800px; color: #fffdd0; }
        section {margin-bottom: 60px;}
        .etel-lista,
        .ital-lista {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
        }

		.wmsg {
			color:#fff;
			text-align:left;

		/* fekete körvonal (sok kis shadow minden irányban) */
			text-shadow:
				1px 1px 0 #000,

				/* plusz glow fehérrel */
				0 0 50px #fff,
				0 0 50px #ccc;
		}

        .cart-btn {
            position: absolute;
            top: 60px;
            right: 20px;
            background-color: rgba(128,128,128,0.5);
            color: white;
            border: none;
            padding: 10px 45px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .cart {
            position: absolute;
            top: 100px;
            right: 20px;
            background-color: rgba(128,128,128,0.8);
            color: white;
            border-radius: 20px;
            padding: 20px;
            width: 250px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
            overflow-y: auto;
            transition: all 0.3s ease;
        }

        .cart-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .cart button.order-btn {
            align-self: center;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
        }

        @keyframes tilt-shaking {
          0% { transform: rotate(0deg); }
          25% { transform: rotate(5deg); }
          50% { transform: rotate(0deg); }
          75% { transform: rotate(-5deg); }
          100% { transform: rotate(0deg); }
        }

        .shake {
          animation: tilt-shaking 0.5s infinite;
        }

        .label-kor {
          position: absolute;
          top: 2px;
          right: 2px;
          width: 40px;
          height: 40px;
          background-color: rgba(40, 40, 40, 0.9);
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
        }

        .label-szoveg {
          color: rgb(200, 50, 50); /* piros */
          font-weight: bold;
          font-size: 16px;
        }
        .label-kor[hidden] { display: none; }

        /* --- Kijelentkezés megerősítő popup --- */
        #logoutConfirmOverlay {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 99999;
        }
        #logoutConfirmOverlay .confirm-box {
          background: rgba(40,40,40,0.95);
          padding: 22px 28px;
          border-radius: 14px;
          max-width: 420px;
          width: 90%;
          color: #fff;
          text-align: center;
          box-shadow: 0 6px 24px rgba(0,0,0,0.6);
        }
        #logoutConfirmOverlay .confirm-box h3 {
          margin: 0 0 12px;
          font-size: 1.1rem;
          letter-spacing: 0.3px;
        }
        #logoutConfirmOverlay .confirm-actions {
          margin-top: 14px;
          display: flex;
          gap: 12px;
          justify-content: center;
        }
        #logoutConfirmOverlay .confirm-actions button {
          padding: 8px 16px;
          border-radius: 10px;
          border: none;
          cursor: pointer;
          font-weight: 600;
        }
        #logoutConfirmOverlay .confirm-yes { background: #4CAF50; color: white; }
        #logoutConfirmOverlay .confirm-no  { background: #b33; color: white; }

    </style>
</head>
<body>
<div class="sidebar">
    <button onclick="fooldal()">Főoldal</button>
    <button onclick="listfoods()">Menü</button>
    <button onclick="rolunk()">Rólunk</button>
    <button onclick="kapcsolat()">Kapcsolat</button>
    <a id="myprofilebutton" style="text-decoration:none; visibility: hidden;"><button style="align:top; background-color: rgba(100,100,100,0.1);">Profilom</button></a>
</div>

<div class="title">ÉTTEREM</div>

<button id="authBtn" class="auth-btn">Bejelentkezés</button>
<button id="cartBtn" class="cart-btn" onclick="updatecart=1;opencart()">Kosár</button> <!-- onmouseleave="closecart()" !-->

<!-- Hero / Főoldal tartalom -->
<div id="hero" class="hero" style="display:none;">
    <h1 class="wmsg">Üdvözlünk az Étteremben</h1>
    <p class="wmsg">Kínálatunk friss, finom és helyi alapanyagokból készül. Nézd meg a menüt, és ha tetszik valami, tedd a kosárba — a rendeléshez be kell jelentkezni.</p>
    <button onclick="listfoods()" style="padding:10px 16px;border-radius:12px;border:none;background:rgba(255,255,255,0.15);color:white;cursor:pointer">Megnézem a menüt</button>
</div>

<div id="etel-container" class="screencontent"></div>



<script>
    // --- segédf-ök ---
    let updatecart = 0;

    function update_cartdb(db) {
        const cb = document.getElementById("cartBtn");
        if (db == 0) {
            cartBtn.value = "Kosár";
        } else {
            cartBtn.value = "Kosár (" + db.toString() + ")";
        }
    }

        async function opencart() {
            // Ne nyisson többet, ha már van
            closecart();
            if (document.getElementById('cartDiv')) return;

            const cartDiv = document.createElement('div');
            cartDiv.id = 'cartDiv';
            cartDiv.className = 'cart';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'cart-content';

            const orderBtn = document.createElement('button');
            orderBtn.className = 'order-btn';

            try {
                const res = await fetch('/api/v1/cart/getcart', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (res.ok) {
                    const items = await res.json();

                    if (items.length === 0) {
                        contentDiv.textContent = "A kosarad üres.";
                        orderBtn.hidden = true;
                        //
                        update_cartdb(0);
                    } else {
                        const list = document.createElement('ul');
                        list.style.listStyle = 'none';
                        list.style.padding = '0';
                        //
                        update_cartdb(items.length);
            // itemek hozzáadása !!!!!!!!!!!!!!!!!!
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.style.textDecoration = 'underline'; // Aláhúzás
                    li.style.cursor = 'pointer'; // Kurzor kézre vált
                    li.title = 'Mennyiség csökkentése -1-el'; // Tooltip szöveg

                    const total = item.price * item.quantity;
                    li.textContent = `${item.name} - ${item.quantity} db = ${total} Ft`;

                    // kártyalabel
                    const kartyalabel = document.getElementById(`label${item.name}`);
                    const kartyalabelkor = document.getElementById(`labelkor${item.name}`);

                    if (kartyalabel) {
                        kartyalabel.textContent = item.quantity.toString();
                    }

                    if (kartyalabelkor) {
                      kartyalabelkor.hidden = false;
                    }

                    li.addEventListener('click', async () => {
                        try {
                            const res = await fetch(`/api/v1/cart/remove/${encodeURIComponent(item.productId)}?type=${encodeURIComponent(item.type)}`, {
                                method: 'POST',
                                credentials: 'same-origin'
                            });

                            if (res.ok) {
                                closecart();
                                opencart(); // újratöltjük a kosarat
                                const kartyalabelkor = document.getElementById(`labelkor${item.name}`);
                                if (kartyalabelkor && (item.quantity - 1) <= 0) kartyalabelkor.hidden = true;
                            } else {
                                const msg = await res.text().catch(() => res.statusText);
                                alert("Hiba a törlés során: " + msg);
                            }
                        } catch (err) {
                            console.error(err);
                            alert("Hálózati hiba: " + err.message);
                        }
                    });
                    orderBtn.textContent = 'Megrendelem';
                    orderBtn.onclick = () => window.location.href = '/checkout';
					const br = document.createElement('br');
					const hr = document.createElement('hr');
                    list.appendChild(li);
					// szépítés
					list.appendChild(br);
					list.appendChild(hr);
					list.appendChild(br);
                });
        // vége!!!!!!!!!!!!!
                        contentDiv.appendChild(list);
                    }
                } else {
                    contentDiv.textContent = "Jelentkezz be a kosarad megtekintéséhez!";
                    orderBtn.textContent = 'Bejelentkezés';
                    orderBtn.onclick = () => window.location.href = '/login';
                }
            } catch (e) {
                contentDiv.textContent = "Nem sikerült lekérni a kosár tartalmát." + e.toString();
                orderBtn.hidden = true;
            }

            cartDiv.appendChild(contentDiv);
            cartDiv.appendChild(orderBtn);

            // Eltüntetés egér elhagyásakor
            cartDiv.addEventListener('mouseleave', closecart);

            if (updatecart == 1) { document.body.appendChild(cartDiv); } else {updatecart = 1}
        }


        function closecart() {
            const cartDiv = document.getElementById('cartDiv');
            if (cartDiv) {
                cartDiv.remove();
            }
        }

    function deletecontent(){ document.getElementById('etel-container').innerHTML = ''; document.getElementById('hero').style.display = 'none'; }
    function fooldal(){
      deletecontent();
      document.getElementById('hero').style.display = 'block';
      document.body.style.display = 'flex';
    }

    function rolunk() {
        deletecontent();
        document.getElementById('etel-container').innerHTML = `
    <section id="about" class="about-section">
              <div class="intro">
                <h1>Rólunk</h1>
                <p>Éttermünk 2005 óta várja vendégeit a legfrissebb alapanyagokból készült fogásokkal.
                Célunk, hogy minden vendégünk otthon érezze magát és különleges élményben legyen része.</p>
              </div>


              <div class="chefs">
                <h2>Ismerje meg szakácsainkat</h2>
                <div class="chef-cards">
                  <div class="chef-card">
                    <img src="pictures/chef1.jpg" alt="Szakács 1">
                    <h4>Kovács Péter</h4>
                    <p>Főszakács</p>
                  </div>
                  <div class="chef-card">
                    <img src="pictures/chef2.jpg" alt="Szakács 2">
                    <h4>Nagy Anna</h4>
                    <p>Cukrász</p>
                  </div>
                  <div class="chef-card">
                    <img src="pictures/chef3.jpg" alt="Szakács 3">
                    <h4>Tóth László</h4>
                    <p>Grillmester</p>
                  </div>
                </div>
              </div>
              <div class="counters">
                <div class="counter">
                  <span class="count" data-target="20">0</span>
                  <p>Éve működünk</p>
                </div>
                <div class="counter">
                  <span class="count" data-target="5000">0</span>
                  <p>Elégedett ügyfél</p>
                </div>
                <div class="counter">
                  <span class="count" data-target="120">0</span>
                  <p>Étel a menün</p>
                </div>
              </div>
              <div class="services">
                <h2>Szolgáltatásaink</h2>
                <div class="service-cards">
                  <div class="service-card">
                    🎉 <h4>Születésnapi party</h4>
                    <p>Hangulatos környezet és személyre szabott menü.</p>
                  </div>
                  <div class="service-card">
                    💼 <h4>Üzleti találkozók</h4>
                    <p>Csendes, elegáns helyszín üzleti megbeszélésekhez.</p>
                  </div>
                  <div class="service-card">
                    💍 <h4>Esküvői party</h4>
                    <p>Exkluzív terek és teljes körű szervezés.</p>
                  </div>
                </div>
              </div>
              <h2>Vendégeink véleménye</h2>
          <div class="carousel">
            <div class="review active">
              <p>"Az étel fantasztikus volt, a kiszolgálás pedig kifogástalan. Csak ajánlani tudom!"</p>
              <h4>– Kovács Anna</h4>
            </div>
            <div class="review">
              <p>"Különleges hangulat, finom ételek és barátságos személyzet. Visszatérünk!"</p>
              <h4>– Szabó Gábor</h4>
            </div>
            <div class="review">
              <p>"Az esküvői vacsoránk itt volt – minden tökéletesen sikerült."</p>
              <h4>– Tóth Eszter</h4>
            </div>
          </div>
</section>

  `;

        const counters = document.querySelectorAll('.count');
        counters.forEach(counter => {
            const updateCount = () => {
                const target = +counter.getAttribute('data-target');
                const count = +counter.innerText;
                const speed = 100; // minél kisebb, annál gyorsabb

                if (count < target) {
                    counter.innerText = count + Math.ceil(target / speed);
                    setTimeout(updateCount, 20);
                } else {
                    counter.innerText = target;
                }
            };
            updateCount();
        });

        let currentReview = 0;
        const reviews = document.querySelectorAll('.review');

        function showNextReview() {
            reviews[currentReview].classList.remove('active');
            currentReview = (currentReview + 1) % reviews.length;
            reviews[currentReview].classList.add('active');
        }

        setInterval(showNextReview, 5000); // 5 másodpercenként vált
    }

    function kapcsolat()
    {
        document.body.style.display = 'flex';
        deletecontent();
        document.getElementById('etel-container').innerHTML = `
     <div class="contact-container">
    <h2>Kapcsolat</h2>
    <form id="contactForm">
      <label for="name">Név:</label><br>
      <input type="text" id="name" required><br><br>

      <label for="email">E-mail:</label><br>
      <input type="email" id="email" required><br><br>

      <label for="message">Üzenet:</label><br>
      <textarea id="message" rows="6" cols="40" required></textarea><br><br>

      <button type="submit">Küldés</button>
    </form>
    <h1>Nyitvatartás</h1>
    <table>
    <tr>
         <th>Hétfő</th>
         <th>Kedd</th>
         <th>Szerda</th>
         <th>Csütörtök</th>
         <th>Péntek</th>
         <th>Szombat</th>
         <th>Vasárnap</th>
    </tr>
    <tr>
        <td>08:00-02:00</td>
        <td>08:00-02:00</td>
        <td>08:00-02:00</td>
        <td>08:00-02:00</td>
        <td>08:00-02:00</td>
        <td>08:00-02:00</td>
        <td>08:00-02:00</td>
    </tr>
    </table>
      <h2>Elérhetőség</h2>
      <ul>
        <li>📍 Debrecen, Fő utca 1.</li>
        <li>📞 +36 30 123 4567</li>
        <li>✉️ info@etterem.hu</li>
      </ul>
    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1601.766789895003!2d21.624890112299912!3d47.53197980900017!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x47470e0b16624e85%3A0x86950f7a0a6bcbfb!2sDebreceni%20Reform%C3%A1tus%20Nagytemplom!5e0!3m2!1shu!2shu!4v1759747825767!5m2!1shu!2shu"
     width="100%" height="450" style="border:0;"
      allowfullscreen="" loading="lazy"
      referrerpolicy="no-referrer-when-downgrade">/iframe>

    <p id="contactResponse"></p>

    </div>
  `;

        // --- JS fetch logika ---
        const form = document.getElementById("contactForm");
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById("name").value,
                email: document.getElementById("email").value,
                message: document.getElementById("message").value
            };

            try {
                const res = await fetch("/api/contact", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const text = await res.text();
                document.getElementById("contactResponse").innerText = res.ok
                    ? "Üzenet sikeresen elküldve!"
                    : "Hiba: " + text;

            } catch (err) {
                document.getElementById("contactResponse").innerText = "Hálózati hiba: " + err.message;
            }
        });
    }

    // -- auth státusz lekérése és gomb beállítása --
    async function loadAuthStatus(){
      const btn = document.getElementById('authBtn');
      btn.textContent = 'Betöltés...';
      btn.onclick = null;

      try {
        const res = await fetch('/api/v1/auth/me', { method: 'GET', credentials: 'same-origin' });
        if (res.ok) {
          const user = await res.json();
          const display = (user && user.email) ? user.email : 'Profil';
          btn.textContent = 'Kijelentkezés (' + display + ')';
          btn.onclick = showLogoutConfirm;
          const profilgomb = document.getElementById("myprofilebutton");
          profilgomb.style.visibility = 'visible';
          profilgomb.onclick = () => window.location.href = '/myprofile';
        } else {
            loggedoutstate();
        }
      } catch (err) {
        console.error('Auth státusz hiba:', err);
        loggedoutstate();
      }
    }
    // DRY
    function loggedoutstate() {
        const btn = document.getElementById('authBtn');
        btn.textContent = 'Bejelentkezés';
        btn.onclick = () => window.location.href = '/login';
        //
        const profilgomb = document.getElementById("myprofilebutton");
        profilgomb.style.visibility = 'hidden';
    }

    // ételek listázása
    async function listetelek() {
        const mainContainer = document.getElementById('etel-container');

        // --- Ételek szekció ---
        const etelSection = document.createElement('section');
        etelSection.innerHTML = '<h2>Ételek</h2>';
        mainContainer.appendChild(etelSection);

        const etelContainer = document.createElement('div');
        etelContainer.className = 'etel-lista';
        etelSection.appendChild(etelContainer);

        const etelLoading = document.createElement('div');
        etelLoading.textContent = 'Ételek betöltése...';
        etelContainer.appendChild(etelLoading);

        try {
            const resEtelek = await fetch('/etelek', { method: 'GET', credentials: 'same-origin' });
            if (!resEtelek.ok) throw new Error(await resEtelek.text());
            const etelek = await resEtelek.json();

            etelContainer.innerHTML = etelek.length
                ? ''
                : '<p>Nincs elérhető étel.</p>';

            etelek.forEach(etel => {
                const kartya = document.createElement('div');
                kartya.className = 'etel-kartya';
                const kepNev = (etel.name || 'default').toLowerCase();
                const kepEleres = `/pictures/${encodeURIComponent(kepNev)}.jpg`;
                const idVal = etel.id ?? etel.name;
                kartya.innerHTML = `
        <div class="label-kor" id="labelkor${etel.name}" hidden>
        <span class="label-szoveg" id="label${etel.name}">0</span>
        </div>
        <img src="${kepEleres}" alt="${escapeHtml(etel.name)}" onerror="this.src='/pictures/default.jpg'">
        <div class="nev">${escapeHtml(etel.name)}</div>
        <div class="ar">${escapeHtml(String(etel.price))} Ft</div>
        <button type="button">Hozzáadás</button>
      `;

                kartya.querySelector('button').addEventListener('click', () => addToCart(idVal, "etel"));
                etelContainer.appendChild(kartya);
            });
        } catch (err) {
            console.error('Hiba az ételek lekérésekor:', err);
            etelContainer.innerHTML = '<p>Hiba történt az ételek betöltésekor.</p>';
        }
    }

    // italok listázása
    async function listitalok() {
        const mainContainer = document.getElementById('etel-container');

        // --- Italok szekció ---
        const italSection = document.createElement('section');
        italSection.innerHTML = '<h2>Italok</h2>';
        mainContainer.appendChild(italSection);

        const italContainer = document.createElement('div');
        italContainer.className = 'ital-lista';
        italSection.appendChild(italContainer);

        const italLoading = document.createElement('div');
        italLoading.textContent = 'Italok betöltése...';
        italContainer.appendChild(italLoading);

        try {
            const resItalok = await fetch('/italok', { method: 'GET', credentials: 'same-origin' });
            if (!resItalok.ok) throw new Error(await resItalok.text());
            const italok = await resItalok.json();

            italContainer.innerHTML = italok.length
                ? ''
                : '<p>Nincs elérhető ital.</p>';

            italok.forEach(ital => {
                const kartya = document.createElement('div');
                kartya.className = 'ital-kartya';
                const kepNev = (ital.name || 'default').toLowerCase();
                const kepEleres = `/pictures/${encodeURIComponent(kepNev)}.jpg`;
                const idVal = ital.id ?? ital.name;

                kartya.innerHTML = `
        <div class="label-kor" id="labelkor${ital.name}" hidden>
        <span class="label-szoveg" id="label${ital.name}">0</span>
        </div>
        <img src="${kepEleres}" alt="${escapeHtml(ital.name)}" onerror="this.src='/pictures/default.jpg'">
        <div class="nev">${escapeHtml(ital.name)}</div>
        <div class="ar">${escapeHtml(String(ital.price))} Ft</div>
        <button type="button">Hozzáadás</button>
      `;

                kartya.querySelector('button').addEventListener('click', () => addToCart(idVal, "ital"));
                italContainer.appendChild(kartya);
            });
        } catch (err) {
            console.error('Hiba az italok lekérésekor:', err);
            italContainer.innerHTML = '<p>Hiba történt az italok betöltésekor.</p>';
        }
    }

    // -- ételek betöltése --
    async function listfoods() {
        document.body.style.display = 'block';
        deletecontent();
        listetelek();
        listitalok(); // DRY!!!
        setTimeout(function() {
            updatecart = 0;
            opencart();
        }, 100);
    }

    function escapeHtml(str){ if (str == null) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

    // -- kosár hozzáadás --
    async function addToCart(productId, type = 'etel') {
      try {
        const res = await fetch(`/api/v1/cart/add/${encodeURIComponent(productId)}?type=${encodeURIComponent(type)}`, {
          method: 'POST',
          credentials: 'same-origin'
        });

        if (res.status === 403 || res.status === 401) {
          showLoginPrompt();
          return;
        }

        if (!res.ok) {
          const text = await res.text().catch(()=>res.statusText);
          alert('Hiba: ' + text);
          return;
        }

        const body = await res.text();
        //alert(body || 'Sikeresen hozzáadva a kosárhoz!'); // alert of cartitemadded
        //
        updatecart = 0;
        opencart();
        shakecart();

      } catch (err) {
        console.error('addToCart hiba:', err);
        alert('Hálózati hiba: ' + err.message);
      }
    }

    // init
    window.addEventListener('load', () => {
      loadAuthStatus();
      fooldal(); // nyitáskor főoldal
    });

    function shakecart() {
      const btn = document.getElementById("cartBtn");
      btn.classList.add("shake");
      setTimeout(function() {
        btn.classList.remove("shake");
      }, 600); // 1000 ms = 1 másodperc
    }

    /* --- showLogoutConfirm: megjelenít egy megerősítő ablakot --- */
    function showLogoutConfirm() {
      // ha már nyitva van, ne nyisson újat
      if (document.getElementById('logoutConfirmOverlay')) return;

      const overlay = document.createElement('div');
      overlay.id = 'logoutConfirmOverlay';
      overlay.innerHTML = `
        <div class="confirm-box" role="dialog" aria-modal="true" aria-labelledby="logout-confirm-title">
          <h3 id="logout-confirm-title">Biztosan ki akarsz jelentkezni?</h3>
          <div class="confirm-actions">
            <button class="confirm-yes">Igen, kijelentkezem</button>
            <button class="confirm-no">Mégse</button>
          </div>
        </div>
      `;

      // kattintással és ESC-sel is zárható legyen
      function removeOverlay() {
        if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
        document.removeEventListener('keydown', onKeydown);
      }
      function onKeydown(e) {
        if (e.key === 'Escape') removeOverlay();
      }

      document.body.appendChild(overlay);
      document.addEventListener('keydown', onKeydown);

      // buttonok
      overlay.querySelector('.confirm-no').addEventListener('click', removeOverlay);
      overlay.querySelector('.confirm-yes').addEventListener('click', async () => {
        removeOverlay();
        // hívjuk a kijelentkezés logikát, de legyen non-blocking (ne használjon újabb native alertet)
        await logoutWithoutAlert();
      });

      // fókusz kezelése (accessibility)
      const noBtn = overlay.querySelector('.confirm-no');
      if (noBtn) noBtn.focus();
    }

    /* --- logoutWithoutAlert: módosított logout ami NEM használ native alert()-et --- */
    async function logoutWithoutAlert() {
      try {
        const res = await fetch('/api/v1/auth/logout', { method: 'POST', credentials: 'same-origin' });
        if (res.ok) {
          // frissítjük az auth státuszt, visszatérítjük a főoldalra
          await loadAuthStatus();
          // opcionális: rövid vizuális visszajelzés (nem native alert)
          showSmallToast('Sikeres kijelentkezés.');
          // vissza a főoldalra
          fooldal();
        } else {
          const t = await res.text().catch(()=>res.statusText);
          showSmallToast('Kijelentkezési hiba: ' + t);
        }
      } catch (e) {
        showSmallToast('Hálózati hiba: ' + e.message);
      }
    }

    /* --- egyszerű, nem blokkoló toast a jobb UX-hez (látható 2s-ig) --- */
    function showSmallToast(msg, ms = 2000) {
      // ha már van toast, frissítjük
      let toast = document.getElementById('smallToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'smallToast';
        toast.style.position = 'fixed';
        toast.style.right = '20px';
        toast.style.bottom = '20px';
        toast.style.background = 'rgba(0,0,0,0.7)';
        toast.style.color = '#fff';
        toast.style.padding = '10px 14px';
        toast.style.borderRadius = '10px';
        toast.style.boxShadow = '0 4px 14px rgba(0,0,0,0.4)';
        toast.style.zIndex = '100000';
        toast.style.fontWeight = '600';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.style.opacity = '1';
      clearTimeout(toast._timeout);
      toast._timeout = setTimeout(() => {
        toast.style.transition = 'opacity 300ms';
        toast.style.opacity = '0';
        setTimeout(()=>{ if (toast && toast.parentNode) toast.parentNode.removeChild(toast); }, 350);
      }, ms);
    }

    /* --- Bejelentkezés szükséges popup --- */
    function showLoginPrompt() {
      if (document.getElementById('loginPromptOverlay')) return;

      const overlay = document.createElement('div');
      overlay.id = 'loginPromptOverlay';
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.6)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '99999';

      overlay.innerHTML = `
        <div class="confirm-box" style="
            background: rgba(40,40,40,0.95);
            padding: 22px 28px;
            border-radius: 14px;
            max-width: 420px;
            width: 90%;
            color: #fff;
            text-align: center;
            box-shadow: 0 6px 24px rgba(0,0,0,0.6);
          ">
          <h3 style="margin:0 0 12px;font-size:1.1rem;">A kosár használatához be kell jelentkezned.</h3>
          <div class="confirm-actions" style="margin-top:14px;display:flex;gap:12px;justify-content:center;">
            <button id="goLoginBtn" style="padding:8px 16px;border:none;border-radius:10px;background:#4CAF50;color:white;font-weight:600;cursor:pointer;">
              Bejelentkezés
            </button>
            <button id="cancelLoginBtn" style="padding:8px 16px;border:none;border-radius:10px;background:#b33;color:white;font-weight:600;cursor:pointer;">
              Mégse
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);

      const removeOverlay = () => overlay.remove();

      document.getElementById('cancelLoginBtn').addEventListener('click', removeOverlay);
      document.getElementById('goLoginBtn').addEventListener('click', () => {
        removeOverlay();
        window.location.href = '/login';
      });

      // ESC gombbal is bezárható
      document.addEventListener('keydown', function escListener(e) {
        if (e.key === 'Escape') {
          removeOverlay();
          document.removeEventListener('keydown', escListener);
        }
      });
    }
</script>
</body>
</html>
